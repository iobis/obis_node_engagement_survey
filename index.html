<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OBIS Nodes Engagement Survey</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- SurveyJS -->
  <script src="https://unpkg.com/survey-jquery@1.9.109/survey.jquery.min.js"></script>
  <link href="https://unpkg.com/survey-core@1.9.109/defaultV2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
    }

    /* Force container width */
    .sv_main,
    .sv-root,
    #surveyContainer,
    .sv-container-modern {
      max-width: 900px !important;
      width: 100% !important;
      margin: 0 auto !important;
      box-sizing: border-box !important;
    }

    /* Prevent full-width behavior */
    .sv-root .sv-container-modern .sv-body {
      max-width: none !important;
    }

    /* Mobile responsiveness */
    @media (max-width: 920px) {
      body {
        padding: 1rem;
      }
      
      .sv_main,
      .sv-root,
      #surveyContainer,
      .sv-container-modern {
        padding: 0 15px !important;
      }
    }
    </style>
</head>
<body>
  <h2>OBIS Nodes Engagement Survey</h2>
  <div id="surveyContainer"></div>

  <script>
    const roles = [
      { value: "Leadership", text: "Leadership (e.g.  Chair, Co-chair, Vice-chair)", tooltip: "Chair, Co-chair, Vice-chair" },
      { value: "Administrative Support", text: "Administrative Support (e.g. Secretary, Coordinator)", tooltip: "Secretary, Coordinator" },
      { value: "Active Member", text: "Active Member (Regular participating member)", tooltip: "Regular participating member" },
      { value: "Observer", text: "Observer (Attends but limited participation)", tooltip: "Attends but limited participation" },
      { value: "Expert/Advisor", text: "Expert/Advisor (Provides specialized knowledge)", tooltip: "Provides specialized knowledge" },
      { value: "Student/Trainee", text: "Student/Trainee (Learning capacity)", tooltip: "Learning capacity" },
      { value: "Liaison", text: "Liaison (Represents another organization)", tooltip: "Represents another organization" },
      { value: "Financial Stakeholder", text: "Financial Stakeholder (Receives or provides funding for participation)", tooltip: "Receives or provides funding for participation" },
      { value: "Project Partner", text: "Project Partner (named collaborator on specific projects or initiatives)", tooltip: "named collaborator on specific projects or initiatives" }
    ];

    const orgs = [
      "GBIF", "TDWG", "GEO BON", "GOOS"
    ];

    const engagementPanel = (org) => ({
      type: "panel",
      name: `panel_${org}`,
      title: `Engagement with ${org}`,
      elements: [
        {
          type: "dropdown",
          name: `${org}_level`,
          title: `Describe your involvement with ${org}:`,
          isRequired: true,
          choices: [
            "I do not work with this group",
            "I passively interact with this group (use services, follow news, mailing list, etc.)",
            "I actively interact with this group (participate on committees, receive funding, etc.)"
          ]
        },
        {
          type: "paneldynamic",
          name: `${org}_engagements`,
          title: "Please describe your active engagements",
          visibleIf: `{${org}_level} = 'I actively interact with this group (participate on committees, receive funding, etc.)'`,
          templateElements: [
            {
              type: "comment",
              name: "description",
              title: "Short Description of Engagement",
              placeholder: "e.g., Marine Biodiversity Working Group",
              isRequired: true
            },
            {
              type: "dropdown",
              name: "role",
              title: "Your Role",
              description: "choose the option that best describes your major role in the engagement",
              choices: JSON.parse(JSON.stringify(roles)),
              isRequired: true
            }
          ],
          panelCount: 1,
          minPanelCount: 1,
          panelAddText: "Add another engagement",
          panelRemoveText: "Remove engagement"
        },
        {
          type: "comment",
          name: `${org}_comments`,
          title: "Any additional comments?",
          visibleIf: `{${org}_level} = 'I actively interact with this group (participate on committees, receive funding, etc.)'`
        }
      ]
    });


    const surveyJSON = {
      title: "OBIS Nodes Engagement Survey",
      showProgressBar: "top",
      pages: [
        {
          name: "basic_info",
          elements: [
            { type: "text", name: "name", title: "Your name", isRequired: true },
            {
              type: "dropdown",
              name: "obisNode",
              title: "OBIS Node Affiliation",
              isRequired: true,
              colCount: 1,
              choices: []  // We'll populate this later
            },
            {
              type: "text",
              name: "oceanExpertID",
              title: "OceanExpert ID",
              description: "Example: https://oceanexpert.org/expert/54167",
              validators: [
                {
                  type: "regex",
                  text: "Please enter a valid OceanExpert URL",
                  regex: "^https://oceanexpert\\.org/expert/\\d+$"
                }
              ]
            },
            {
              type: "text",
              name: "orcid",
              title: "ORCID",
              description: "Example: https://orcid.org/0000-0000-0000-0000",
              validators: [
                {
                  type: "regex",
                  text: "Please enter a valid ORCID URL",
                  regex: "^https://orcid\\.org/\\d{4}-\\d{4}-\\d{4}-\\d{3}[\\dX]$"
                }
              ]
            }
          ]
        },
        ...orgs.map(engagementPanel),
        {
          name: "other_groups",
          title: "Other Groups",
          elements: [
            {
              type: "matrixdynamic",
              name: "other_engagements",
              title: "Describe interactions with any additional groups that you feel the OBIS community should be aware of",
              columns: [
                { name: "role", title: "Type of Interaction", cellType: "dropdown", choices: [...roles] }, // Create a new array copy here too
                { name: "group", title: "Short Description (e.g. IPBES Task Force on Indigenous and Local Knowledge)", cellType: "text" }
              ],
              rowCount: 1,
              addRowText: "Add another engagement"
            },
            {
              type: "comment",
              name: "other_comments",
              title: "Any additional comments?"
            }
          ]
        }
      ]
    };

   $(document).ready(function () {
      const survey = new Survey.Model(surveyJSON);

      survey.onComplete.add(function (sender) {
        fetch("https://script.google.com/macros/s/AKfycbzR8dfv3oU_uoR7ObFmwckCtmIG71mLj-cKbw60GmvBmzj_LpvIEdg90DNs5tF55DyF/exec", {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify(sender.data)
        })
        .then(response => {
          if (response.ok) {
            alert("✅ Thank you! Your response has been submitted.");
          } else {
            alert("❌ There was a problem submitting your response.");
          }
        })
        .catch(error => {
          console.error("POST to Google Sheets failed:", error);
          alert("❌ There was a network error.");
        });
      });

      // Render the survey first
      $("#surveyContainer").Survey({ model: survey });

      // Then fetch and populate the OBIS nodes
      fetch("https://api.obis.org/v3/node")
      .then(res => res.json())
      .then(data => {
        
        const nodeChoices = data.results.map(node => ({
        value: node.name,
        text: node.name
      })).sort((a, b) => a.text.localeCompare(b.text));  // ✅ Sort by display text

        const obisQuestion = survey.getQuestionByName("obisNode");
        if (obisQuestion) {
          obisQuestion.choices = nodeChoices;
          console.log("✅ OBIS dropdown populated:", nodeChoices);
        } else {
          console.warn("❌ Could not find the 'obisNode' question.");
        }
      });
  
    });


  </script>
</body>
</html>