<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OBIS Nodes Engagement Survey</title>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- SurveyJS -->
  <script src="https://unpkg.com/survey-jquery@1.9.109/survey.jquery.min.js"></script>
  <link href="https://unpkg.com/survey-core@1.9.109/defaultV2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
    }
    .sv_main {
      max-width: 900px;
      margin: auto;
    }
  </style>
</head>
<body>
  <h2>OBIS Nodes Engagement Survey</h2>
  <div id="surveyContainer"></div>

  <script>
    const roles = [
      { value: "Chair", text: "Chair", tooltip: "Leads the group, chairs meetings, coordinates decisions" },
      { value: "Co-chair", text: "Co-chair", tooltip: "Shares leadership duties with another Chair" },
      { value: "Vice-chair", text: "Vice-chair", tooltip: "Supports the Chair and may lead in their absence" },
      { value: "Secretary", text: "Secretary", tooltip: "Maintains records and documentation for the group" },
      { value: "Rapporteur", text: "Rapporteur", tooltip: "Summarizes discussions and prepares official reports" },
      { value: "Coordinator", text: "Coordinator", tooltip: "Manages logistics and communication for the group" },
      { value: "Facilitator", text: "Facilitator", tooltip: "Supports inclusive and effective discussion, often neutral" },
      { value: "Member", text: "Member", tooltip: "Participates regularly without additional duties" },
      { value: "Observer", text: "Observer", tooltip: "Attends group meetings without formal decision-making power" },
      { value: "Student", text: "Student", tooltip: "Participates in a learning or training capacity" },
      { value: "Guest", text: "Guest", tooltip: "Invited temporarily for a specific topic or session" },
      { value: "Funder", text: "Funder", tooltip: "Provides financial support to a group or project" },
      { value: "Funded Member", text: "Funded Member", tooltip: "Participates in a group with financial support from another organization" },
      { value: "Advisor", text: "Advisor", tooltip: "Provides strategic, policy, or technical advice to the group" },
      { value: "Supervised Member", text: "Supervised Member", tooltip: "Acts under the direction or oversight of a parent institution" },
      { value: "Seconded Member", text: "Seconded Member", tooltip: "Temporarily assigned to the group by another organization" },
      { value: "Embedded Expert", text: "Embedded Expert", tooltip: "Hosted within the group but representing another entity" },
      { value: "Hosted Member", text: "Hosted Member", tooltip: "Operates within the group's facilities or organizational structure" },
      { value: "Liaison", text: "Liaison", tooltip: "Represents another organization's interests within the group" },
      { value: "Technical Expert", text: "Technical Expert", tooltip: "Provides subject matter expertise on a specific topic or domain" }
    ];

    const orgs = [
      "GBIF", "TDWG", "GEO BON", "GOOS", "ODIS", "UNEP", "IOC", "CBD"
    ];

    const engagementPanel = (org) => ({
      type: "panel",
      name: `panel_${org}`,
      title: `Engagement with ${org}`,
      elements: [
        {
          type: "radiogroup",
          name: `${org}_involved`,
          title: `Do you work with ${org}?`,
          isRequired: true,
          choices: ["Yes", "No"]
        },
        {
          type: "radiogroup",
          name: `${org}_level`,
          visibleIf: `{${org}_involved} = 'Yes'`,
          title: "Which statement best describes your involvement?",
          choices: [
            "I actively interact with this group (participate on committees, receive funding, etc.)",
            "I passively interact with this group (follow news, mailing list, etc.)"
          ]
        },
        {
            type: "matrixdynamic",
            name: "other_engagements",
            title: "Describe interactions with other groups not listed above",
            columns: [
              { name: "role", title: "Type of Interaction", cellType: "dropdown", choices: roles },
              { name: "group", title: "Short Description", cellType: "text" }
            ],
            rowCount: 1,
            addRowText: "Add another engagement"
          },
        {
          type: "comment",
          name: `${org}_comments`,
          title: "Any additional comments?"
        }
      ]
    });


    const surveyJSON = {
      title: "OBIS Nodes Engagement Survey",
      showProgressBar: "top",
      pages: [
        {
          name: "basic_info",
          elements: [
            { type: "text", name: "name", title: "Your name", isRequired: true },
            { type: "text", name: "oceanExpertID", title: "OceanExpert ID (if known)" },
            {
              type: "dropdown",
              name: "obisNode",
              title: "OBIS Node Affiliation",
              isRequired: true,
              colCount: 1,
              choices: []  // We'll populate this later
            }

          ]
        },
        ...orgs.map(engagementPanel),
        {
          name: "other_groups",
          title: "Other Groups",
          elements: [
            {
              type: "matrixdynamic",
              name: "other_engagements",
              title: "Describe interactions with other groups not listed above",
              columns: [
                { name: "group", title: "Name of group/forum", cellType: "text" },
                { name: "role", title: "Description of interaction", cellType: "dropdown", choices: roles }
              ],
              rowCount: 1,
              addRowText: "Add another engagement"
            },
            {
              type: "comment",
              name: "other_comments",
              title: "Any additional comments?"
            }
          ]
        }
      ]
    };

   $(document).ready(function () {
      const survey = new Survey.Model(surveyJSON);

      survey.onComplete.add(function (sender) {
        fetch("https://script.google.com/a/macros/formeldataservices.com/s/AKfycbz6CKltIxXWnfJfQBKZL9sG3JB5-2uBkW0ixglf8zuaHJI-O1jkBITJIbko-0CcfA1l/exec", {
          method: "POST",
          body: JSON.stringify(sender.data),
          headers: {
            "Content-Type": "application/json"
          }
        })
        .then(response => {
          if (response.ok) {
            alert("✅ Thank you! Your response has been submitted.");
          } else {
            alert("❌ There was a problem submitting your response.");
          }
        })
        .catch(error => {
          console.error("POST to Google Sheets failed:", error);
          alert("❌ There was a network error.");
        });
      });


      // Render the survey first
      $("#surveyContainer").Survey({ model: survey });

      // Then fetch and populate the OBIS nodes
      fetch("https://api.obis.org/v3/node")
      .then(res => res.json())
      .then(data => {
        
        const nodeChoices = data.results.map(node => ({
        value: node.name,
        text: node.name
      })).sort((a, b) => a.text.localeCompare(b.text));  // ✅ Sort by display text

        const obisQuestion = survey.getQuestionByName("obisNode");
        if (obisQuestion) {
          obisQuestion.choices = nodeChoices;
          console.log("✅ OBIS dropdown populated:", nodeChoices);
        } else {
          console.warn("❌ Could not find the 'obisNode' question.");
        }
      });
  
    });


  </script>
</body>
</html>
